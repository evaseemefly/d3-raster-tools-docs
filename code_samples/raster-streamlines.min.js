// raster-streamlines Version 0.0.1. Copyright 2016 Roger Veciana i Rovira.
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.rastertools=t.rastertools||{})}(this,function(t){"use strict";function e(t,e){if(t.length<=1||e.length<=1||t[0].length<=1||e[0].length<=1)throw new Error("Raster is too small");this.uData=t,this.vData=e,this.usedPixels=[];for(var a=0;a<t.length;a++){for(var h=[],i=0;i<t[0].length;i++)h.push(!1);this.usedPixels.push(h)}}var a=function(t,a,h,i){var o={type:"FeatureCollection",features:[]},r=0,l=new e(t,a);if(h){if(6!==h.length)throw new Error("Bad geotransform")}else h=[0,1,0,0,0,1];for(var s,u,f=!0,n=!0,M=0;f;)M%4===0?(s=0,u=0):M%4===1?(s=t[0].length-1,u=t.length-1):M%4===2?(s=t[0].length-1,u=0):(s=0,u=t.length-1),f=l.findEmptyPixel(s,u,1),n=l.getLine(f.x,f.y,i),n&&(o.features.push({type:"Feature",geometry:{type:"LineString",coordinates:l.applyGeoTransform(n,h)},properties:{num_line:r}}),r++),M++;return o};e.prototype.findEmptyPixel=function(t,e,a){if(this.isPixelFree(t,e,a))return{x:t,y:e};for(var h=this.uData[0].length+this.uData.length,i=2;i<=h+1;i+=2)for(var o=0;o<i;o++){if(this.isPixelFree(o+1+t-i/2,e-i/2,a))return{x:o+1+t-i/2,y:e-i/2};if(this.isPixelFree(t-i/2,o+e-i/2,a))return{x:t-i/2,y:o+e-i/2};if(this.isPixelFree(i+t-i/2,o+1+e-i/2,a))return{x:i+t-i/2,y:o+1+e-i/2};if(this.isPixelFree(o+t-i/2,i+e-i/2,a))return{x:o+t-i/2,y:i+e-i/2}}return!1},e.prototype.isPixelFree=function(t,e,a){if(t<0||t>=this.usedPixels[0].length||e<0||e>=this.usedPixels.length)return!1;for(var h=-a;h<=a;h++)for(var i=-a;i<=a;i++)if(e+i>=0&&e+i<this.usedPixels.length&&t+h>=0&&t+h<this.usedPixels[e].length&&this.usedPixels[e+i][t+h])return!1;return!0},e.prototype.getLine=function(t,e,a){var h,i=!1,o=t,r=e,l=[[o,r]];for(a=a?1:-1;o>=0&&o<this.uData[0].length&&r>=0&&r<this.uData.length;){if(h=this.getValueAtPoint(o,r),o+=h.u,r+=a*h.v,0===h.u&&0===h.v){this.usedPixels[e][t]=!0;break}if(o<0||r<0||o>=this.uData[0].length||r>=this.uData.length||this.usedPixels[Math.floor(r)][Math.floor(o)])break;l.push([o,r]),i=!0,this.usedPixels[Math.floor(r)][Math.floor(o)]=!0}for(o=t,r=e;o>=0&&o<this.uData[0].length&&r>=0&&r<this.uData.length;){if(h=this.getValueAtPoint(o,r),o-=h.u,r-=a*h.v,0===h.u&&0===h.v){this.usedPixels[e][t]=!0;break}if(o<0||r<0||o>=this.uData[0].length||r>=this.uData.length||this.usedPixels[Math.floor(r)][Math.floor(o)])break;l.unshift([o,r]),i=!0,this.usedPixels[Math.floor(r)][Math.floor(o)]=!0}return!!i&&(this.usedPixels[e][t]=!0,l)},e.prototype.applyGeoTransform=function(t,e){for(var a=[],h=0;h<t.length;h++)a.push([e[0]+e[1]*t[h][0]+e[2]*t[h][1],e[3]+e[4]*t[h][0]+e[5]*t[h][1]]);return a},e.prototype.getValueAtPoint=function(t,e){var a,h,i,o,r=Math.sqrt((Math.floor(t)-t)*(Math.floor(t)-t)+(Math.floor(e)-e)*(Math.floor(e)-e)),l=Math.sqrt((Math.floor(t)-t)*(Math.floor(t)-t)+(Math.ceil(e)-e)*(Math.ceil(e)-e)),s=Math.sqrt((Math.ceil(t)-t)*(Math.ceil(t)-t)+(Math.ceil(e)-e)*(Math.ceil(e)-e)),u=Math.sqrt((Math.ceil(t)-t)*(Math.ceil(t)-t)+(Math.floor(e)-e)*(Math.floor(e)-e));return r<.01?(a=this.uData[Math.floor(e)][Math.floor(t)],h=this.vData[Math.floor(e)][Math.floor(t)]):l<.01?(a=this.uData[Math.ceil(e)][Math.floor(t)],h=this.vData[Math.ceil(e)][Math.floor(t)]):s<.01?(a=this.uData[Math.ceil(e)][Math.ceil(t)],h=this.vData[Math.ceil(e)][Math.ceil(t)]):u<.01?(a=this.uData[Math.floor(e)][Math.ceil(t)],h=this.vData[Math.floor(e)][Math.ceil(t)]):(o=0,a=0,h=0,this.uData[Math.floor(e)]&&this.uData[Math.floor(e)][Math.floor(t)]&&(a+=this.uData[Math.floor(e)][Math.floor(t)]/r,h+=this.vData[Math.floor(e)][Math.floor(t)]/r,o+=1/r),this.uData[Math.ceil(e)]&&this.uData[Math.ceil(e)][Math.floor(t)]&&(a+=this.uData[Math.ceil(e)][Math.floor(t)]/l,h+=this.vData[Math.ceil(e)][Math.floor(t)]/l,o+=1/l),this.uData[Math.ceil(e)]&&this.uData[Math.ceil(e)][Math.ceil(t)]&&(a+=this.uData[Math.ceil(e)][Math.ceil(t)]/s,h+=this.vData[Math.ceil(e)][Math.ceil(t)]/s,o+=1/s),this.uData[Math.floor(e)]&&this.uData[Math.floor(e)][Math.ceil(t)]&&(a+=this.uData[Math.floor(e)][Math.ceil(t)]/u,h+=this.vData[Math.floor(e)][Math.ceil(t)]/u,o+=1/u),a/=o,h/=o),i=Math.sqrt(a*a+h*h),0!==i&&0!==o?{u:a/i,v:h/i}:{u:0,v:0}},t.streamlines=a,Object.defineProperty(t,"__esModule",{value:!0})});